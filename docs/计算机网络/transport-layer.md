# 传输层

TCP/IP协议簇中的传输层位于应用层和网络层之间。为应用层提供服务，接收来自网络层的服务。传输层是客户端程序和服务器程序的联络人，是进程到进程的连接。传输层是TCP/IP的核心；是互联网点到点交换数据的逻辑媒介。

## 介绍

传输层在两个应用层之间提供进程到进程的服务，一个进程在本地，另一个在远程主机。两个应用层存在一条假想的直接逻辑链路。传输层为应用层提供了两种可用协议。一种是UDP，一种是TCP。UDP提供不可靠、无连接的服务，TCP提供可靠、面向连接的服务。应用层程序必须指明使用哪一种运输层协议。

UDP和TCP的基本职责是，将两个端系统间IP的交付服务扩展为运行在端系统上的两个进程之间的交付服务。将主机间交付扩展到进程间交付被称为运输层的**多路复用**（multiplexing）和**多路分解**（demultiplexing）。UDP和TCP还可以提供报文的完整性检查。进程间的数据交付和差错校验是运输层提供的最低限度的服务，也是UDP仅能提供的两种服务。TCP则提供了多种附加服务，比如可靠数据传输、拥塞控制等。

## 多路复用和多路分解

将运输层报文段中的数据交付到正确的套接字的工作称为**多路分解**。在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息生成报文，然后将报文传递到网络层，这些工作称为**多路复用**。

我们使用IP来定义主机。为了定义和标识进程，我们需要第二个标识符，称为端口号。在TCP/IP协议簇中，端口号是16位整数（0～65535）。

客户端程序使用端口号定义自己，这属于临时端口号，因为它只在客户端程序运行期间短暂存在。临时端口号推荐大于1023。

服务器进程必须使用一个端口号定义自己。但这个端口号不能随意选择。TCP/IP使用全局端口号，又称**熟知端口号（well-known port number）**。

在与终端通信时，IP和端口号起着不同的作用。IP地址用来确定唯一主机，端口号确定该主机上的唯一进程。

ICANN把端口号编码划分为三种范围：
1. 熟知端口。0～1023，由ICANN分配和控制。
2. 注册端口。1024～49151。ICANN不分配不控制，可在ICANN注册以防止重复。
3. 动态端口。49152～65535。不受控制也不需要注册，任何进程都可以使用。

### 无连接的多路复用和多路分解

UDP套接字由二元组构成（目的IP地址、目的端口号）。发送方为UDP报文写入目的端口号、源端口号后，交给网络层转发。接收方收到多个UDP报文时，通过提取首部的目的端口号，将数据交给对应的套接字进程。

### 面向连接的多路复用和分解

TCP套接字由四元组构成（源IP地址、源端口号、目的IP地址、目的端口号）。当一个TCP报文到达，接收方通过全部4个字段来确认唯一套接字并交付数据。与UDP不同的点在于，如果两个TCP报文源IP或者源端口不同，TCP可能会将数据交给不同的套接字处理，因为TCP是面向连接的。

## 无连接运输UDP

UDP仅仅对IP协议做了很小的扩展——差错校验和复用/分解。使用UDP发送报文前，发送方和接收方的运输层实体之间没有握手。因此UDP被称为是无连接的。

### UDP报文结构

UDP报文由首部和数据部分组成。UDP首部只有四个字段：源端口号、目的端口号、长度、校验和。

### UDP校验和

发送方的UDP对报文段中的所有16比特序列的和进行反码计算，求和时高位溢出会被回卷到低位，计算的结果存入校验和字段。在接收方，将16比特序列再进行加法运算，如果没有差错，则结果应该是全1。UDP实现差错校验是基于端到端原则，该原则表述为因为某种功能必须基于端到端实现，与较高级别协议提供这些功能相比，在较低级别上设置的功能可能是荣誉或者几乎没有价值的。UDP能校验差错，但不能纠错。UDP只能丢弃出错的报文，或者交给应用程序自行处理。






<!-- ### 进程间通信
传输层的首要任务是提供进程到进程的通信。进程是使用传输层服务的应用层实体（应用程序）。网络层负责计算机层次的通信，网络层协议只把报文传递到目的主机，而报文还需要传递给正确的进程，这正是由运输层提供的服务。传输层确保将报文传递给正确的进程。

### 寻址：端口号

我们使用IP来定义主机。为了定义和标识进程，我们需要第二个标识符，称为端口号。在TCP/IP协议簇中，端口号是16位整数（0～65535）。

客户端程序使用端口号定义自己，这属于临时端口号，因为它只在客户端程序运行期间短暂存在。临时端口号推荐大于1023。

服务器进程必须使用一个端口号定义自己。但这个端口号不能随意选择。TCP/IP使用全局端口号，又称**熟知端口号（well-known port number）**。

在与终端通信时，IP和端口号起着不同的作用。IP地址用来确定唯一主机，端口号确定该主机上的唯一进程。

ICANN把端口号编码划分为三种范围：
1. 熟知端口。0～1023，由ICANN分配和控制。
2. 注册端口。1024～49151。ICANN不分配不控制，可在ICANN注册以防止重复。
3. 动态端口。49152～65535。不受控制也不需要注册，任何进程都可以使用。

一个IP和一个端口号结合起来称为套接字（socket）。客户套接字地址定义了客户进程，服务器套接字地址定义了服务器进程。 -->

<!-- ### 封包与拆包

传输层协议负责封装和拆封应用层下发的报文，进程将报文和套接字地址一起发送给传输层。封装发生在发送端，传输层接收数据并带上传输层头部。因特网中传输层的分组称为**用户数据报（user datagram）**、**段（segment）**或者**分组（packet）**，这取决于我们使用什么传输层协议。拆封发生在接收端，报文到达目的传输层后，头部被拆掉丢弃，传输层将报文传递到套接字指定的应用层进程。

### 多路复用与多路分解

每当一个实体从一个以上的源接收到数据时，称为**多路复用**（multiplexing，多对一）；每当一个实体将数据传递到一个以上的源时，称为**多路分解**（demultiplexing，一对多）。源端的传输层执行多路复用，目的端的传输层执行多路分解。

### 流量控制

每当一个实体创建数据并且有另一个实体消耗它们时，就存在生产速率和消费速率的平衡问题。如果生产比消费快，那么消费者可能需要丢弃数据。如果生产比消费慢，那么消费者就需要等待，系统效率将降低。流量控制与前者相关，需要在消费端防止丢弃数据。

#### push and pull

生产者传递数据给消费者有两种方式：推（push）和拉（pull）。发送方产生数据，不需要消费方的请求就将他们发送，这称为推。生产者请求之后才发送，这称为拉。当生产者推数据，消费者可能被数据淹没，并需要反向控制流量。当消费者主动请求数据，这时候消费者应当做好了准备，这种情况下不需要流量控制。

#### 传输层流量控制

传输层通信需要处理的实体有4个：发送方进程、发送方传输层、接收方传输层、接收方进程。发送方进程只是一个生产者，它生产报文然后推到传输层。发送方传输层有两个作用：既是消费者也是生产者。它消费进程下发的报文，生产传递给网络层的报文。接收方传输层也有两个作用：首先是消费者，消费来自源传输层的报文，它也是生产者，将报文拆包后交给应用进程。

因此，我们至少需要两种流量控制：
1. 发送方传输层到发送方应用层的流量控制
2. 接收方传输层到发送方传输层的流量控制
![](https://gitee.com/ksleo/source/raw/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120210112021135.png)

#### 缓冲区

通常的流量控制方式是使用两个缓冲区：一个位于发送方传输层、一个位于接收方传输层。缓冲区是一块内存单元，用来存储分组。

当发送方传输层的缓冲区已满，它就通知发送方应用层停止发送报文；有空闲位置再通知应用层发送报文。

当接收方传输层的缓冲区已满，它就通知发送方应用层停止发送分组；有空闲位置再通知发送方传输层继续发送分组。

### 差错控制

由于网络层提供不可靠服务，如果应用层需要可靠性，则传输层就需要变得可靠。可靠性通过传输层的差错控制来实现。传输层的差错控制负责以下几方面：
1. 发现并丢弃被破坏的分组
2. 记录丢失和丢弃的分组并重传
3. 识别重复分组并丢弃
4. 缓冲失序分组直到丢失的分组到达变为有序

#### 序号

通过对分组加入序号，传输层就可以知道哪些分组是重复的，哪些分组丢失了。当分组被破坏或者丢失，接受方传输层可通过某种方式通知放松方传输层重传该序号分组。分组序号的范围取决于协议所允许的分组字段位数m，该范围是0～2^m - 1。

#### 确认

可以发送积极或者消极的信号作为差错控制，这里只讨论积极信号，这在传输层中最常见，接收方可以为每一组正确到达的分组发送一个确认（ACK）。接收方可以简单的丢弃被破坏的分组。发送方如果使用计时器，它就可以发现丢失分组。当一个分组被发送，发送方就开启一个计时器。如果ACK在计时器超时之前还没到达，就认为它丢失进行重发。重复的分组可以被接收方丢弃。失序的分组既可以丢弃，也可以缓存知道丢失的分组到达变得有序。

### 流量和差错控制组合

之前已经说过，流量控制需要两个缓冲区，差错控制需要使用序号和确认号。使用两个带序号的缓冲区，这两者就可以结合起来。

在发送端，当分组准备发送，我们使用下一个缓冲区空闲位置号码x作为分组序号，当分组被发送，一个分组的备份存储在内存位置x，等待来自接收端的确认。当ACK到达，该内存就被释放。
在接收端，当带有序号y的分组到达，他被存储在内存位置y上，直到应用层准备好接收它，此时发送一个ACK表示分组y已经到达。


#### 滑动窗口

 -->

## 可靠数据传输机制
 - 校验和

    用于检测一个传输分组中的比特流错误

 - 定时器

    用于超时/重传一个分组。可能因为该分组（或其ACK）在信道中丢失了。接收方可能接收到同一个分组的冗余副本。

 - 序号

    用于数据流按顺序编号，接收分组的序号间隙可使接收方检测分组丢失。相同序号的分组可以让接收方检测到冗余副本。

 - 确认

    接收方告知发送方一个分组被正确接收。确认报文通常携带被确认分组的序号。确认可以是逐个，也可以是累积。

 - 否定确认

    接收方告知发送方某个分组未被正确接收。否定报文通常携带未被正确接收的分组序号。

 - 滑动窗口、流水线

    发送方被限制仅发送落在窗口内的分组。允许一次发送多个分组但未被确认，发送方的利用率在停等协议的基础上被增加。窗口长度可以根据吞吐量、网络拥塞情况来动态设置。


## 面向连接的运输TCP

### TCP连接

TCP连接没有物理实体，属于逻辑线路。TCP协议只在端系统中允许，所以中间的网络设备（路由器、交换机）不会维持TCP连接状态。路由器对TCP对连接完全视而不见，它看到的只是数据报。TCP连接是点对点的，因此不具备多播功能。

客户端发送一个特殊的TCP报文段，服务器用另一个特殊的报文段相应，最后客户端用第三个特殊报文段相应。前两个报文段不包含应用层数据；第三个报文段可以承载应用层数据。由于连接过程发送了三个报文段，所以这种连接过程被称为**三次握手（three-way handshake）**。

TCP连接建立后，两个远程进程就可以通信了。TCP将应用层的数据引导至**发送缓冲区**（send buffer），发送缓冲区是三次握手期间创建的缓冲区之一。TCP会从缓冲区取数据发送到网络层。TCP从缓冲区读取的数据长度受限于**最大报文段长度（Maximum Segment Size，MSS）**。MSS通常根据本地主机的最大链路层帧长度（即**最大传输单元（Maximum Transmission Unit，MTU）**）来设置。以太网和PPP链路层协议都具有1500字节的MTU，因此MSS的值一般设置为1460（为TCP/IP首部预留40字节位置）。

TCP为每块数据追加一个TCP首部，从而形成多个**TCP报文段**（TCP segment），这些报文段下发给网络层后，封装成IP数据报发送到网络中。TCP接收到一个报文段后，将其放入接收缓冲区，应用程序可以通过缓冲区读取数据。

### TCP报文结构

TCP报文由首部和数据字段构成。首部包括：
 - 源端口号。
 - 目的端口号。
 - 